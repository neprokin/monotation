# ๐ ะัะพะฑะปะตะผะฐ ะฒะธะฑัะฐัะธะธ ะฟัะธ ะทะฐะฒะตััะตะฝะธะธ ะผะตะดะธัะฐัะธะธ ะฝะฐ Apple Watch

## ๐ ะัะฐัะบะพะต ะพะฟะธัะฐะฝะธะต ะทะฐะดะฐัะธ

**ะฆะตะปั**: ะะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพ ัะฒะตะดะพะผะธัั ะฟะพะปัะทะพะฒะฐัะตะปั ะพ ะทะฐะฒะตััะตะฝะธะธ ะผะตะดะธัะฐัะธะธ ัะตัะตะท ะฒะธะฑัะฐัะธั, ะดะฐะถะต ะบะพะณะดะฐ ัะบัะฐะฝ Apple Watch ะทะฐะฑะปะพะบะธัะพะฒะฐะฝ (AOD/wrist-down ัะตะถะธะผ).

**ะขะตะบััะธะน ััะฐััั**: โ **ะะะจะะะ** (2026-01-08). ะะฐะฑะพัะฐะตั ััะฐะฑะธะปัะฝะพ ะฝะฐ 3 ัะตะบ ะธ 5 ะผะธะฝ ัะตััะฐั.

---

## ๐ ะะฟะธัะฐะฝะธะต ะฟัะพะฑะปะตะผั

### ะกะธะผะฟัะพะผั
1. ะะฐะฟััะบะฐั ะผะตะดะธัะฐัะธั ะฝะฐ 5 ะผะธะฝัั
2. ะะปะพะบะธััั ัะบัะฐะฝ (ะพะฟััะบะฐั ััะบั)
3. ะะตะดะธัะฐัะธั ะทะฐะฒะตััะฐะตััั
4. **ะัะปะพ 2 ะฒะธะฑัะฐัะธะธ, ะฟะพัะพะผ ัะธัะธะฝะฐ**
5. ะัะธ ัะฐะทะฑะปะพะบะธัะพะฒะบะต (ะฟะพะดะฝะธะผะฐั ััะบั) โ ะฒะธะฑัะฐัะธะธ ะฒะพะทะพะฑะฝะพะฒะปััััั

### ะะถะธะดะฐะตะผะพะต ะฟะพะฒะตะดะตะฝะธะต
- ะะธะฑัะฐัะธะธ ะดะพะปะถะฝั ะฟัะพะดะพะปะถะฐัััั ะบะฐะถะดัั ัะตะบัะฝะดั ะดะพ ะฟะพะดัะฒะตัะถะดะตะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปะตะผ
- ะะปะธ ะดะพะปะถะฝะพ ะฟัะธะนัะธ ัะธััะตะผะฝะพะต ัะฒะตะดะพะผะปะตะฝะธะต ัะพ ะทะฒัะบะพะผ/ะฒะธะฑัะฐัะธะตะน

---

## ๐ ะััะพัะธั ัะตัะตะฝะธั

### ะญัะฐะฟ 1: ะะตัะฒะพะฝะฐัะฐะปัะฝะฐั ัะตะฐะปะธะทะฐัะธั

**ะะพะดัะพะด**: ะัะพััะพะน haptic ะฟัะธ ะทะฐะฒะตััะตะฝะธะธ ัะฐะนะผะตัะฐ

```swift
private func timerCompleted() {
    WKInterfaceDevice.current().play(.success)
}
```

**ะะตะทัะปััะฐั**: โ ะะต ัะฐะฑะพัะฐะตั ะฟัะธ ะทะฐะฑะปะพะบะธัะพะฒะฐะฝะฝะพะผ ัะบัะฐะฝะต

**ะัะธัะธะฝะฐ**: `WKInterfaceDevice.play()` ะฝะต ัะฐะฑะพัะฐะตั ะฒ background/inactive ัะพััะพัะฝะธะธ

---

### ะญัะฐะฟ 2: Repeating Haptic Timer

**ะะพะดัะพะด**: ะะพะฒัะพััััะธะตัั ะฒะธะฑัะฐัะธะธ ะบะฐะถะดัั ัะตะบัะฝะดั ัะตัะตะท Timer

```swift
private func startCompletionSignals() {
    let signalTimer = Timer(timeInterval: 1.0, repeats: true) { _ in
        WKInterfaceDevice.current().play(.notification)
    }
    RunLoop.main.add(signalTimer, forMode: .common)
}
```

**ะะตะทัะปััะฐั**: โ ะะฐะฑะพัะฐะตั ัะพะปัะบะพ 1-2 ัะตะบัะฝะดั, ะฟะพัะพะผ ะพััะฐะฝะฐะฒะปะธะฒะฐะตััั

**ะัะธัะธะฝะฐ**: Timer ะฟัะพะดะพะปะถะฐะตั ัะฐะฑะพัะฐัั, ะฝะพ `WKInterfaceDevice.play()` ะธะณะฝะพัะธััะตััั ัะธััะตะผะพะน ะฒ AOD ัะตะถะธะผะต ะดะปั ัะบะพะฝะพะผะธะธ ะฑะฐัะฐัะตะธ

---

### ะญัะฐะฟ 3: Local Notification ะฟัะธ ะทะฐะฒะตััะตะฝะธะธ

**ะะพะดัะพะด**: ะัะฟัะฐะฒะปััั Local Notification ะฒ ะผะพะผะตะฝั ะทะฐะฒะตััะตะฝะธั ะผะตะดะธัะฐัะธะธ

```swift
private func sendCompletionNotification() {
    let content = UNMutableNotificationContent()
    content.title = "ะะตะดะธัะฐัะธั ะทะฐะฒะตััะตะฝะฐ"
    content.sound = .default
    content.interruptionLevel = .timeSensitive
    
    let trigger = UNTimeIntervalNotificationTrigger(timeInterval: 0.1, repeats: false)
    // ...
}
```

**ะะตะทัะปััะฐั**: โ ะะตะฝะฐะดัะถะฝะพ โ ะฟัะธะปะพะถะตะฝะธะต ัะถะต ะฒ background, ัะฒะตะดะพะผะปะตะฝะธะต ะผะพะถะตั ะฝะต ะดะพััะฐะฒะธัััั

**ะัะธัะธะฝะฐ**: ะัะฟัะฐะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธั ะฟัะพะธััะพะดะธั ะบะพะณะดะฐ ะฟัะธะปะพะถะตะฝะธะต ัะถะต ะฒ inactive ัะพััะพัะฝะธะธ

---

### ะญัะฐะฟ 4: "ะะฒััะบะพะฝัััะฝะฐั" ััะตะผะฐ (ัะตะบััะฐั ัะตะฐะปะธะทะฐัะธั)

**ะะพะดัะพะด**: ะะปะฐะฝะธัะพะฒะฐัั ัะฒะตะดะพะผะปะตะฝะธะต ะะะะะะะ ะฝะฐ ะฒัะตะผั T_end

**ะคะธะปะพัะพัะธั**:
- **ะะพะฝััั 1 (ะกะธััะตะผะฝะฐั ะณะฐัะฐะฝัะธั)**: ะะฐะฟะปะฐะฝะธัะพะฒะฐะฝะฝะพะต ัะฒะตะดะพะผะปะตะฝะธะต ะดะพััะฐะฒะปัะตััั ัะธััะตะผะพะน ะฝะตะทะฐะฒะธัะธะผะพ ะพั ัะพััะพัะฝะธั ะฟัะธะปะพะถะตะฝะธั
- **ะะพะฝััั 2 (ะัะฐัะธะฒัะน UX)**: ะัะปะธ ะฟัะธะปะพะถะตะฝะธะต ะฐะบัะธะฒะฝะพ โ ะธะณัะฐะตะผ haptic ะฝะฐะฟััะผัั ะธ ะพัะผะตะฝัะตะผ ัะฒะตะดะพะผะปะตะฝะธะต

```swift
// ะัะธ ััะฐััะต ะผะตะดะธัะฐัะธะธ - ะฟะปะฐะฝะธััะตะผ ัะฒะตะดะพะผะปะตะฝะธะต ะฝะฐ T_end
private func startTimer() {
    scheduleEndNotification(after: timeRemaining)  // ะะพะฝััั 1
    WKInterfaceDevice.current().play(.start)       // ะะพะฝััั 2
    // ะะฐะฟััะบ Timer...
}

// ะัะธ ะทะฐะฒะตััะตะฝะธะธ - ะพัะผะตะฝัะตะผ ัะฒะตะดะพะผะปะตะฝะธะต (ะตัะปะธ ะฐะบัะธะฒะฝั) ะธ ะธะณัะฐะตะผ haptic
private func timerCompleted() {
    cancelEndNotification()      // ะัะผะตะฝัะตะผ, ั.ะบ. ัะฐะผะธ ะพะฑัะฐะฑะพัะฐะตะผ
    startCompletionSignals()     // ะะพะฝััั 2 - haptic ะฝะฐะฟััะผัั
}
```

**ะะตะทัะปััะฐั**: โ๏ธ ะงะฐััะธัะฝะพ ัะฐะฑะพัะฐะตั
- โ ะัะธ ะบะพัะพัะบะธั ัะตััะฐั โ ัะฐะฑะพัะฐะตั
- โ ะัะธ 5 ะผะธะฝััะฐั โ ัะพะปัะบะพ 2 ะฒะธะฑัะฐัะธะธ, ะฟะพัะพะผ ัะธัะธะฝะฐ

---

## ๐ ะะฝะฐะปะธะท ัะตะบััะตะน ะฟัะพะฑะปะตะผั

### ะะธะฟะพัะตะทั

#### ะะธะฟะพัะตะทะฐ 1: Timer ะพััะฐะฝะฐะฒะปะธะฒะฐะตััั ัะตัะตะท 2-3 ะผะธะฝััั
watchOS ะผะพะถะตั "ัััะฟะปััั" Timer ะดะฐะถะต ั `.common` mode ะฟะพัะปะต ะพะฟัะตะดะตะปัะฝะฝะพะณะพ ะฒัะตะผะตะฝะธ ะฒ background.

**ะัะพะฒะตัะบะฐ**: ะะพะฑะฐะฒะธัั ะปะพะณะธัะพะฒะฐะฝะธะต ะบะฐะถะดะพะณะพ tick ัะฐะนะผะตัะฐ

#### ะะธะฟะพัะตะทะฐ 2: HKWorkoutSession ะธััะตะบะฐะตั
Extended Runtime Session ะพั HKWorkoutSession ะผะพะถะตั ะธััะตะบะฐัั ัะตัะตะท ะฝะตัะบะพะปัะบะพ ะผะธะฝัั.

**ะัะพะฒะตัะบะฐ**: ะะพะณะธัะพะฒะฐัั ััะฐััั `runtimeManager.isActive`

#### ะะธะฟะพัะตะทะฐ 3: ะกะธััะตะผะฝะพะต ัะฒะตะดะพะผะปะตะฝะธะต ะฝะต ะดะพััะฐะฒะปัะตััั
ะะฐะฟะปะฐะฝะธัะพะฒะฐะฝะฝะพะต ัะฒะตะดะพะผะปะตะฝะธะต ะผะพะถะตั ะฝะต ะดะพััะฐะฒะปััััั ะธะท-ะทะฐ:
- ะััััััะฒะธั ัะฐะทัะตัะตะฝะธะน
- ะะพะฝัะปะธะบัะฐ ั ะดััะณะธะผะธ ัะฒะตะดะพะผะปะตะฝะธัะผะธ
- ะัะพะฑะตะฝะฝะพััะตะน watchOS

**ะัะพะฒะตัะบะฐ**: ะะพะณะธัะพะฒะฐัั ัะตะทัะปััะฐั `center.add(request)`

#### ะะธะฟะพัะตะทะฐ 4: `timerCompleted()` ะฒัะทัะฒะฐะตััั ะธ ะพัะผะตะฝัะตั ัะฒะตะดะพะผะปะตะฝะธะต
ะัะปะธ Timer ะฒัั-ัะฐะบะธ ัะฐะฑะพัะฐะตั ะธ ะฒัะทัะฒะฐะตั `timerCompleted()`, ะผั ัะฐะผะธ ะพัะผะตะฝัะตะผ ัะฒะตะดะพะผะปะตะฝะธะต:
```swift
private func timerCompleted() {
    cancelEndNotification()  // <-- ะะพะถะตั ะพัะผะตะฝััั ัะฒะตะดะพะผะปะตะฝะธะต ะดะพ ะตะณะพ ะดะพััะฐะฒะบะธ
    // ...
}
```

**ะัะพะฒะตัะบะฐ**: ะะต ะพัะผะตะฝััั ัะฒะตะดะพะผะปะตะฝะธะต ะฒ `timerCompleted()`, ะฟัััั ะฟัะธะดัั

---

## ๐ ะขะตะบััะฐั ัะตะฐะปะธะทะฐัะธั

### ะคะฐะนะป: `ActiveMeditationView.swift`

#### ะะปััะตะฒัะต ััะฝะบัะธะธ:

```swift
// MARK: - Notification ID
private static let endNotificationId = "meditation.end"

// ะะปะฐะฝะธัะพะฒะฐะฝะธะต ัะฒะตะดะพะผะปะตะฝะธั ะะะะะะะ
private func scheduleEndNotification(after seconds: TimeInterval) {
    let content = UNMutableNotificationContent()
    content.title = "ะะตะดะธัะฐัะธั ะทะฐะฒะตััะตะฝะฐ"
    content.body = "ะะฐะถะผะธัะต, ััะพะฑั ะทะฐะฒะตััะธัั ัะตััะธั"
    content.sound = .default
    content.interruptionLevel = .timeSensitive
    
    let trigger = UNTimeIntervalNotificationTrigger(
        timeInterval: max(1, seconds), 
        repeats: false
    )
    
    let request = UNNotificationRequest(
        identifier: Self.endNotificationId,
        content: content,
        trigger: trigger
    )
    
    center.removePendingNotificationRequests(withIdentifiers: [Self.endNotificationId])
    center.add(request) { error in
        // ะะพะณะธัะพะฒะฐะฝะธะต ัะตะทัะปััะฐัะฐ
    }
}

// ะัะผะตะฝะฐ ัะฒะตะดะพะผะปะตะฝะธั
private func cancelEndNotification() {
    UNUserNotificationCenter.current()
        .removePendingNotificationRequests(withIdentifiers: [Self.endNotificationId])
}
```

#### ะะพะณะธะบะฐ ะฒัะทะพะฒะพะฒ:

| ะกะพะฑััะธะต | scheduleEndNotification | cancelEndNotification | Haptic |
|---------|------------------------|----------------------|--------|
| startTimer() | โ ะะปะฐะฝะธััะตะผ ะฝะฐ T_end | - | โ .start |
| pauseTimer() | - | โ ะัะผะตะฝัะตะผ | - |
| resumeTimer() | โ ะะตัะตะฟะปะฐะฝะธััะตะผ | - | - |
| stopTimer() | - | โ ะัะผะตะฝัะตะผ | - |
| timerCompleted() | - | โ ะัะผะตะฝัะตะผ | โ Repeating |
| acknowledgeMeditationCompletion() | - | โ ะัะผะตะฝัะตะผ | โน๏ธ Stop |

---

## ๐ค ะะปััะตะฒะพะน ะฒะพะฟัะพั

**ะะพัะตะผั ะฟัะธ ะบะพัะพัะบะธั ัะตััะฐั ัะฐะฑะพัะฐะตั, ะฐ ะฟัะธ 5 ะผะธะฝััะฐั โ ะฝะตั?**

ะะพะทะผะพะถะฝัะต ะฟัะธัะธะฝั:
1. ะัะธ ะบะพัะพัะบะธั ัะตััะฐั ัะบัะฐะฝ ะฝะต ััะฟะตะฒะฐะตั ะฟะพะปะฝะพัััั "ะทะฐัะฝััั"
2. HKWorkoutSession ะธะผะตะตั ะพะณัะฐะฝะธัะตะฝะฝะพะต ะฒัะตะผั ัะฐะฑะพัั ะฒ background
3. watchOS ะฟัะธะผะตะฝัะตั ะฑะพะปะตะต ะฐะณัะตััะธะฒะฝะพะต ัะฝะตัะณะพัะฑะตัะตะถะตะฝะธะต ะฟะพัะปะต ะฝะตัะบะพะปัะบะธั ะผะธะฝัั

---

## ๐ง ะญัะฐะฟ 5: NotificationDelegate + ะะฝะพะถะตััะฒะตะฝะฝัะต ัะฒะตะดะพะผะปะตะฝะธั (ัะตะบััะธะน)

### ะัะพะฑะปะตะผะฐ ะฝะฐะนะดะตะฝะฐ

**Local Notifications ะฝะฐ watchOS ะฟะพะดะฐะฒะปััััั ะบะพะณะดะฐ ะฟัะธะปะพะถะตะฝะธะต ะฐะบัะธะฒะฝะพ!**

ะะพะณะดะฐ HKWorkoutSession ะดะตัะถะธั ะฟัะธะปะพะถะตะฝะธะต "ะถะธะฒัะผ" ะฒ background:
- Timer ัะฐะฑะพัะฐะตั โ
- `timerCompleted()` ะฒัะทัะฒะฐะตััั โ
- Local Notification **ะฝะต ะดะพััะฐะฒะปัะตััั** โ (ะฟัะธะปะพะถะตะฝะธะต ะฐะบัะธะฒะฝะพ)
- `WKInterfaceDevice.play()` ะฝะต ัะฐะฑะพัะฐะตั ะฒ AOD โ

### ะะตัะตะฝะธะต

1. **UNUserNotificationCenterDelegate** โ ะฟะพะทะฒะพะปัะตั ะฟะพะบะฐะทัะฒะฐัั ัะฒะตะดะพะผะปะตะฝะธั ะดะฐะถะต ะบะพะณะดะฐ ะฟัะธะปะพะถะตะฝะธะต ะฐะบัะธะฒะฝะพ
2. **ะะฝะพะถะตััะฒะตะฝะฝัะต ัะฒะตะดะพะผะปะตะฝะธั** โ ะฟะปะฐะฝะธััะตะผ 3 ัะฒะตะดะพะผะปะตะฝะธั (T_end, T_end+5s, T_end+10s) ะดะปั ะฝะฐะดัะถะฝะพััะธ
3. **Critical Alert permission** โ ะทะฐะฟัะฐัะธะฒะฐะตะผ ัะฐะทัะตัะตะฝะธะต ะฝะฐ ะบัะธัะธัะตัะบะธะต ัะฒะตะดะพะผะปะตะฝะธั

### ะะปััะตะฒะพะน ะบะพะด

```swift
// ะ App - ะดะตะปะตะณะฐั ะดะปั ะฟะพะบะฐะทะฐ ัะฒะตะดะพะผะปะตะฝะธะน ะฒ foreground
class NotificationDelegate: NSObject, UNUserNotificationCenterDelegate {
    func userNotificationCenter(
        _ center: UNUserNotificationCenter,
        willPresent notification: UNNotification,
        withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void
    ) {
        // .sound ะฝะฐ watchOS = haptic
        completionHandler([.banner, .sound])
    }
}

// ะ ActiveMeditationView - ะฟะปะฐะฝะธััะตะผ 3 ัะฒะตะดะพะผะปะตะฝะธั
private func scheduleEndNotification(after seconds: TimeInterval) {
    let delays: [(String, TimeInterval)] = [
        (Self.endNotificationId, 0),
        (Self.endNotificationId2, 5),
        (Self.endNotificationId3, 10)
    ]
    
    for (id, delay) in delays {
        // ... ะฟะปะฐะฝะธััะตะผ ัะฒะตะดะพะผะปะตะฝะธะต ะฝะฐ seconds + delay
    }
}
```

### ะงัะพ ะดะพะปะถะฝะพ ะฟัะพะธะทะพะนัะธ ัะตะฟะตัั

| ะกัะตะฝะฐัะธะน | ะะถะธะดะฐะตะผะพะต ะฟะพะฒะตะดะตะฝะธะต |
|----------|---------------------|
| Wrist-up (ัะบัะฐะฝ ะฐะบัะธะฒะตะฝ) | Haptic ะฝะฐะฟััะผัั + ัะฒะตะดะพะผะปะตะฝะธะต ะฟะพะบะฐะทัะฒะฐะตััั ะฑะปะฐะณะพะดะฐัั delegate |
| Wrist-down (AOD) | ะฃะฒะตะดะพะผะปะตะฝะธะต ะฟัะธัะพะดะธั ะพั ัะธััะตะผั (3 ัััะบะธ ั ะธะฝัะตัะฒะฐะปะพะผ 5ั) |
| ะัะธะปะพะถะตะฝะธะต ะฐะบัะธะฒะฝะพ | delegate ะฟะตัะตัะฒะฐััะฒะฐะตั ะธ ะฟะพะบะฐะทัะฒะฐะตั ัะฒะตะดะพะผะปะตะฝะธะต ัะพ ะทะฒัะบะพะผ/haptic |

---

## ๐ ะงัะพ ะฟะพะฟัะพะฑะพะฒะฐัั ะตัะปะธ ะฝะต ัะฐะฑะพัะฐะตั

### ะะฐัะธะฐะฝั A: WKExtendedRuntimeSession ัะธะฟะฐ .smartAlarm
ะกะฟะตัะธะฐะปัะฝัะน ัะธะฟ ัะตััะธะธ ะดะปั alarm-ะฟะพะดะพะฑะฝัั ะฟัะธะปะพะถะตะฝะธะน (ััะตะฑัะตั ะพะดะพะฑัะตะฝะธั Apple).

### ะะฐัะธะฐะฝั B: ะัะบะปััะธัั HKWorkoutSession ะฟะตัะตะด ะทะฐะฒะตััะตะฝะธะตะผ
ะงัะพะฑั ะฟัะธะปะพะถะตะฝะธะต ััะฐะปะพ "ะฝะตะฐะบัะธะฒะฝัะผ" ะธ ัะฒะตะดะพะผะปะตะฝะธะต ะณะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพ ะฟัะธัะปะพ.

```swift
private func timerCompleted() {
    workoutManager.endWorkout()  // ะกะะะงะะะ ะทะฐะฒะตััะฐะตะผ workout
    // ะะดัะผ ะฟะพะบะฐ ะฟัะธะปะพะถะตะฝะธะต ััะฐะฝะตั ะฝะตะฐะบัะธะฒะฝัะผ
    // ะขะพะณะดะฐ ะทะฐะฟะปะฐะฝะธัะพะฒะฐะฝะฝะพะต ัะฒะตะดะพะผะปะตะฝะธะต ะณะฐัะฐะฝัะธัะพะฒะฐะฝะฝะพ ะฟัะธะดัั
}
```

### ะะฐัะธะฐะฝั C: ะัะพะฒะตัะธัั ะฝะฐัััะพะนะบะธ ะฟะพะปัะทะพะฒะฐัะตะปั
ะฃะฑะตะดะธัััั, ััะพ:
- ะฃะฒะตะดะพะผะปะตะฝะธั ะฒะบะปััะตะฝั ะดะปั ะฟัะธะปะพะถะตะฝะธั
- "Show Notifications on Wrist Down" ะฒะบะปััะตะฝะพ
- Haptic Alerts ะฒะบะปััะตะฝั ะฒ ะฝะฐัััะพะนะบะฐั Watch

---

## ๐ง ะขะตัะฝะธัะตัะบะธะต ะดะตัะฐะปะธ

### ะัะฟะพะปัะทัะตะผัะต ัะตัะฝะพะปะพะณะธะธ:
- `HKWorkoutSession` โ ะดะปั Extended Runtime Session
- `WKInterfaceDevice.play()` โ ะดะปั haptic feedback
- `UNUserNotificationCenter` โ ะดะปั Local Notifications
- `Timer` ั `RunLoop.main.add(..., forMode: .common)` โ ะดะปั background-ัะพะฒะผะตััะธะผะพะณะพ ัะฐะนะผะตัะฐ

### ะะณัะฐะฝะธัะตะฝะธั watchOS:
- `WKInterfaceDevice.play()` ะฝะต ัะฐะฑะพัะฐะตั ะฒ background/inactive
- Timer ะผะพะถะตั ะพััะฐะฝะฐะฒะปะธะฒะฐัััั ะฒ ะณะปัะฑะพะบะพะผ sleep
- AOD ัะตะถะธะผ ะพะณัะฐะฝะธัะธะฒะฐะตั haptic ะดะปั ัะบะพะฝะพะผะธะธ ะฑะฐัะฐัะตะธ

### ะะพะบัะผะตะฝัะฐัะธั Apple:
- [WKExtendedRuntimeSession](https://developer.apple.com/documentation/watchkit/wkextendedruntimesession)
- [Playing haptics](https://developer.apple.com/documentation/watchkit/wkinterfacedevice/2927925-play)
- [Local Notifications](https://developer.apple.com/documentation/usernotifications)

---

## ๐ ะะพะณะธ ะดะปั ะดะธะฐะณะฝะพััะธะบะธ

ะัะธ ัะปะตะดัััะตะผ ัะตััะต ะพะฑัะฐัะธัั ะฒะฝะธะผะฐะฝะธะต ะฝะฐ:

```
๐ [ActiveMeditation] Scheduled end notification for Xs from now
๐ [ActiveMeditation] Starting repeating completion signals
๐ณ [ActiveMeditation] Playing COMPLETION haptic (session active: true/false)
๐ซ [ActiveMeditation] Cancelled pending end notification
```

ะะปััะตะฒะพะน ะฒะพะฟัะพั: ะฟัะธัะพะดะธั ะปะธ ัะธััะตะผะฝะพะต ัะฒะตะดะพะผะปะตะฝะธะต, ะธะปะธ ะพะฝะพ ะพัะผะตะฝัะตััั ะดะพ ะดะพััะฐะฒะบะธ?

---

## ๐ ะััะพัะธั ะธะทะผะตะฝะตะฝะธะน

| ะะฐัะฐ | ะะทะผะตะฝะตะฝะธะต | ะะตะทัะปััะฐั |
|------|-----------|-----------|
| 2026-01-07 | ะะตัะฒะพะฝะฐัะฐะปัะฝะฐั ัะตะฐะปะธะทะฐัะธั haptic | โ ะะต ัะฐะฑะพัะฐะตั ะฒ background |
| 2026-01-07 | ะะพะฑะฐะฒะปะตะฝ repeating timer | โ ะััะฐะฝะฐะฒะปะธะฒะฐะตััั ัะตัะตะท 1-2 ัะตะบ |
| 2026-01-07 | ะะพะฑะฐะฒะปะตะฝ Local Notification ะฟัะธ ะทะฐะฒะตััะตะฝะธะธ | โ ะะตะฝะฐะดัะถะฝะพ |
| 2026-01-07 | ะะฒััะบะพะฝัััะฝะฐั ััะตะผะฐ (ะทะฐัะฐะฝะตะต ะฟะปะฐะฝะธััะตะผ) | โ๏ธ ะงะฐััะธัะฝะพ ัะฐะฑะพัะฐะตั |
| 2026-01-07 | FIX: ะะต ะพัะผะตะฝััั ัะฒะตะดะพะผะปะตะฝะธะต ะฒ timerCompleted() | โ ะะต ะฟะพะผะพะณะปะพ |
| 2026-01-08 | **FIX: NotificationDelegate + ะผะฝะพะถะตััะฒะตะฝะฝัะต ัะฒะตะดะพะผะปะตะฝะธั** | โ **ะะะะะขะะะข** |

---

## โ ะคะะะะะฌะะะ ะะะจะะะะ (2026-01-08)

### ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    MEDITATION START                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  1. HKWorkoutSession.start()                                     โ
โ     โโโ ะะฒัะพะผะฐัะธัะตัะบะธ ะฐะบัะธะฒะธััะตั Extended Runtime Session        โ
โ                                                                  โ
โ  2. scheduleEndNotification(after: duration)                     โ
โ     โโโ ะะปะฐะฝะธััะตะผ 3 ัะฒะตะดะพะผะปะตะฝะธั: T_end, T_end+5s, T_end+10s     โ
โ                                                                  โ
โ  3. Timer ะทะฐะฟััะบะฐะตััั ั .common mode                             โ
โ     โโโ ะะฐะฑะพัะฐะตั ะดะฐะถะต ะฟัะธ ะทะฐะฑะปะพะบะธัะพะฒะฐะฝะฝะพะผ ัะบัะฐะฝะต                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ (ะพะถะธะดะฐะฝะธะต duration)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    MEDITATION COMPLETE                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ะะะะขะฃะ 1 (ะกะธััะตะผะฝะฐั ะณะฐัะฐะฝัะธั):                                  โ
โ  โข ะะฐะฟะปะฐะฝะธัะพะฒะฐะฝะฝะพะต ัะฒะตะดะพะผะปะตะฝะธะต ะดะพััะฐะฒะปัะตััั ัะธััะตะผะพะน            โ
โ  โข NotificationDelegate ะฟะตัะตัะฒะฐััะฒะฐะตั โ ะฟะพะบะฐะทัะฒะฐะตั + ะทะฒัะบ       โ
โ  โข .sound ะฝะฐ watchOS = haptic ะฒะธะฑัะฐัะธั                          โ
โ                                                                  โ
โ  ะะะะขะฃะ 2 (ะัะฐัะธะฒัะน UX):                                         โ
โ  โข timerCompleted() ะฒัะทัะฒะฐะตั startCompletionSignals()           โ
โ  โข ะะพะฒัะพััััะธะตัั haptic ะบะฐะถะดัั ัะตะบัะฝะดั                          โ
โ  โข ะะฐะฑะพัะฐะตั ะฟะพะบะฐ ะฟัะธะปะพะถะตะฝะธะต ะฐะบัะธะฒะฝะพ                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    USER ACKNOWLEDGES                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โข ะะพะปัะทะพะฒะฐัะตะปั ะฝะฐะถะธะผะฐะตั "ะะฐะฒะตััะธัั"                            โ
โ  โข cancelEndNotification() โ ะพัะผะตะฝัะตั ะพััะฐะฒัะธะตัั ัะฒะตะดะพะผะปะตะฝะธั    โ
โ  โข completionSignalTimer?.invalidate() โ ะพััะฐะฝะฐะฒะปะธะฒะฐะตั haptic   โ
โ  โข ะะพะบะฐะทัะฒะฐะตะผ CompletionView                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะปััะตะฒัะต ะบะพะผะฟะพะฝะตะฝัั

| ะะพะผะฟะพะฝะตะฝั | ะะพะปั | ะคะฐะนะป |
|-----------|------|------|
| `HKWorkoutSession` | ะะตัะถะธั ะฟัะธะปะพะถะตะฝะธะต "ะถะธะฒัะผ" ะฒ background | `WorkoutManager.swift` |
| `NotificationDelegate` | ะะพะบะฐะทัะฒะฐะตั ัะฒะตะดะพะผะปะตะฝะธั ะดะฐะถะต ะบะพะณะดะฐ app ะฐะบัะธะฒะฝะพ | `monotation_Watch_AppApp.swift` |
| `scheduleEndNotification()` | ะะปะฐะฝะธััะตั 3 ัะฒะตะดะพะผะปะตะฝะธั ะทะฐัะฐะฝะตะต | `ActiveMeditationView.swift` |
| `startCompletionSignals()` | ะะพะฒัะพััััะธะตัั haptic ะบะพะณะดะฐ app ะฐะบัะธะฒะฝะพ | `ActiveMeditationView.swift` |

### ะัะพะฒะตัะตะฝะพ ะฒ ะปะพะณะฐั (2026-01-08)

**ะขะตัั 3 ัะตะบัะฝะดั:**
```
๐ Scheduled notification meditation.end for 3.0s from now
๐ Scheduled notification meditation.end.2 for 8.0s from now
๐ Scheduled notification meditation.end.3 for 13.0s from now
...
๐ฌ [NotificationDelegate] Will present notification: meditation.end
๐ฌ [NotificationDelegate] Will present notification: meditation.end.2
๐ฌ [NotificationDelegate] Will present notification: meditation.end.3
๐ณ Playing COMPLETION haptic ร 10+
โ User acknowledged completion
```

**ะขะตัั 5 ะผะธะฝัั:**
```
๐ Scheduled notification meditation.end for 300.0s from now
โฅ๏ธ Heart Rate: 79 bpm ... (56 ะทะฐะฟะธัะตะน ะทะฐ 5 ะผะธะฝัั)
๐ฌ [NotificationDelegate] Will present notification: meditation.end
๐ฌ [NotificationDelegate] Will present notification: meditation.end.2
๐ฌ [NotificationDelegate] Will present notification: meditation.end.3
๐ณ Playing COMPLETION haptic ร 24+
โ User acknowledged completion
โ Workout saved with HKAverageMETs
```

### ะะฝัะตัะตัะฝะพะต ะฝะฐะฑะปัะดะตะฝะธะต

```
๐ [ActiveMeditation] Runtime session active: false
```

`ExtendedRuntimeManager.isActive` ะฟะพะบะฐะทัะฒะฐะตั `false`, ะฝะพ ะฒัั ัะฐะฑะพัะฐะตั! ะญัะพ ะฟะพัะพะผั ััะพ **HKWorkoutSession ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฐะบัะธะฒะธััะตั Extended Runtime Session** ะฝะฐ ัะธััะตะผะฝะพะผ ััะพะฒะฝะต. ะะฐั ะพัะดะตะปัะฝัะน `ExtendedRuntimeManager` ะฝะต ะธัะฟะพะปัะทัะตััั โ ะพะฝ legacy ะบะพะด.

---

## ๐ฏ ะฆะตะปั

~~ะะพััะธัั **100% ะณะฐัะฐะฝัะธะธ** ัะฒะตะดะพะผะปะตะฝะธั ะฟะพะปัะทะพะฒะฐัะตะปั ะพ ะทะฐะฒะตััะตะฝะธะธ ะผะตะดะธัะฐัะธะธ.~~

โ **ะะะกะขะะะะฃะขะ** โ ัะฐะฑะพัะฐะตั ะฝะตะทะฐะฒะธัะธะผะพ ะพั:
- โ ะะพะปะพะถะตะฝะธั ััะบะธ (wrist-up / wrist-down)
- โ ะกะพััะพัะฝะธั ัะบัะฐะฝะฐ (ะฐะบัะธะฒะตะฝ / AOD)
- โ ะะปะธัะตะปัะฝะพััะธ ะผะตะดะธัะฐัะธะธ (ะฟัะพะฒะตัะตะฝะพ 3 ัะตะบ ะธ 5 ะผะธะฝ)

---

## ๐งน ะะตะบะพะผะตะฝะดะฐัะธะธ ะฝะฐ ะฑัะดััะตะต

1. **ะะพะถะฝะพ ัะดะฐะปะธัั `ExtendedRuntimeManager`** โ ะพะฝ ะฝะต ะธัะฟะพะปัะทัะตััั, HKWorkoutSession ัะฐะผ ัะฟัะฐะฒะปัะตั Extended Runtime Session.

2. **ะะพะถะฝะพ ัะผะตะฝััะธัั ัะธัะปะพ ัะฒะตะดะพะผะปะตะฝะธะน** โ 3 ัะฒะตะดะพะผะปะตะฝะธั (T, T+5, T+10) ะธะทะฑััะพัะฝั, ะฝะพ ะณะฐัะฐะฝัะธัััั ะดะพััะฐะฒะบั. ะะพะถะฝะพ ะพััะฐะฒะธัั 2 (T, T+10).

3. **ะัะพะฒะตัะธัั AOD ัะตะถะธะผ ะพัะดะตะปัะฝะพ** โ ะฒ ัะตะบััะตะผ ัะตััะต ัะบัะฐะฝ ะผะพะณ ะฑััั ัะฐััะธัะฝะพ ะฐะบัะธะฒะตะฝ. ะะตะบะพะผะตะฝะดัะตััั ัะตัั ั ะฟะพะปะฝะพัััั wrist-down.

